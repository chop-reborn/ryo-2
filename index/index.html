<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>飲食店 MVP v2.3.2（顧客の来店回数対応）</title>
  <style>
    body {
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,sans-serif;
      background:#f7f7f9;
    }
    header {
      position:sticky;
      top:0;
      background:#fff;
      border-bottom:1px solid #e5e5e5;
      z-index:10;
    }
    h1 {
      margin:0;
      padding:12px 16px;
      font-size:18px;
    }
    nav {
      display:flex;
      gap:6px;
      padding:8px;
      flex-wrap:wrap;
    }
    nav button {
      flex:1;
      min-width:110px;
      padding:10px;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      cursor:pointer;
    }
    nav button.active {
      background:#0a7cff;
      color:#fff;
      border-color:#0a7cff;
    }
    main {
      max-width:1000px;
      margin:0 auto;
      padding:16px;
    }
    section {
      background:#fff;
      border-radius:10px;
      box-shadow:0 1px 4px rgba(0,0,0,.05);
      padding:16px;
      margin:0 0 16px;
    }
    .hidden {
      display:none;
    }
    .row {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .col {
      flex:1;
      min-width:180px;
    }
    label {
      display:block;
      font-size:12px;
      color:#666;
      margin:6px 0 4px;
    }
    input, textarea {
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fff;
    }
    textarea {
      min-height:90px;
    }
    .btn {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
    }
    .btn.primary {
      background:#0a7cff;
      color:#fff;
      border-color:#0a7cff;
    }
    .btn.danger {
      background:#ff4d4f;
      color:#fff;
      border-color:#ff4d4f;
    }
    .btn.ghost {
      background:#fff;
      border-color:#0a7cff;
      color:#0a7cff;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:14px;
    }
    th, td {
      border-bottom:1px solid #eee;
      padding:8px;
      text-align:left;
      vertical-align:top;
    }
    th {
      background:#fafafa;
    }
    .right { text-align:right; }
    .pill {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#eef5ff;
      font-size:12px;
    }
    .visbtn {
      padding:4px 8px;
      border:1px solid #ccc;
      border-radius:6px;
      background:#fff;
      cursor:pointer;
    }
    .nowrap { white-space:nowrap; }
  </style>
</head>
<body>
  <header>
    <h1>飲食店 MVP v2.3.2</h1>
    <nav>
      <button data-tab="home" class="active">ホーム</button>
      <button data-tab="sales">売上入力</button>
      <button data-tab="customers">顧客台帳</button>
      <button data-tab="line">LINE配信</button>
      <button data-tab="settings">設定</button>
    </nav>
  </header>
  <main>
    <!-- ホーム -->
    <section id="home">
      <h2>今日のダッシュボード</h2>
      <div>今日の売上合計：<b id="todayTotal">0</b> 円</div>
      <div>現金：<b id="todayCash">0</b> ／ カード：<b id="todayCard">0</b> ／ CL合計：<b id="todayCL">0</b></div>
      <div style="margin-top:10px">
        来店回数（全体）：
        <button id="decVisit">−</button>
        <b id="visitCount">0</b>
        <button id="incVisit">＋</button>
      </div>
      <h3 style="margin-top:16px">日別サマリー</h3>
      <table>
        <thead>
          <tr>
            <th>日付</th><th>合計</th><th>現金</th><th>カード</th><th>CL</th><th>件数</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </section>
    <!-- 売上入力 -->
    <section id="sales" class="hidden">
      <h2>売上入力</h2>
      <label>日付 <input type="date" id="saleDate"></label><br>
      <label>現金 <input type="number" id="cash"></label>
      <label>カード <input type="number" id="card"></label><br>
      <label>CL-PayPay <input type="number" id="cl_paypay"></label>
      <label>CL-交通系 <input type="number" id="cl_transit"></label>
      <label>CL-その他 <input type="number" id="cl_other"></label><br>
      <label>メモ <input id="saleNote"></label><br>
      <button id="saveSale" class="btn primary">保存</button>
      <h3>売上一覧</h3>
      <table>
        <thead>
          <tr>
            <th>日付</th><th>メモ</th><th>内訳</th><th>合計</th>
          </tr>
        </thead>
        <tbody id="salesBody"></tbody>
      </table>
    </section>
    <!-- 顧客台帳 -->
    <section id="customers" class="hidden">
      <h2>顧客台帳</h2>
      <label>名前 <input id="custName"></label>
      <label>連絡先 <input id="custContact"></label>
      <label>メモ <input id="custMemo"></label><br>
      <button id="saveCustomer" class="btn primary">保存</button>
      <h3>顧客一覧</h3>
      <table>
        <thead>
          <tr>
            <th>名前</th><th>連絡先</th><th>メモ</th><th>来店回数</th>
          </tr>
        </thead>
        <tbody id="custBody"></tbody>
      </table>
    </section>
    <!-- LINE -->
    <section id="line" class="hidden">
      <h2>LINE配信（ダミー）</h2>
      <textarea id="lineMsg"></textarea><br>
      <button id="sendLine" class="btn primary">配信する</button>
    </section>

    <!-- 設定 -->
    <section id="settings" class="hidden">
      <h2>設定</h2>
      <button id="resetData" class="btn danger">データ削除</button>
    </section>
  </main>
  <script>
    const SALES_KEY = 'sales', CUST_KEY = 'customers', VISIT_KEY = 'visits';
    const fmt = n => Number(n||0).toLocaleString();

    // タブ切替
    document.querySelectorAll("nav button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
      });
    });

    // 売上保存
    function getSales(){ return JSON.parse(localStorage.getItem(SALES_KEY) || "[]"); }
    function setSales(v){ localStorage.setItem(SALES_KEY, JSON.stringify(v)); }
    document.getElementById("saveSale").onclick = () => {
      const rec = {
        date: document.getElementById("saleDate").value,
        cash: Number(document.getElementById("cash").value||0),
        card: Number(document.getElementById("card").value||0),
        cl_paypay: Number(document.getElementById("cl_paypay").value||0),
        cl_transit: Number(document.getElementById("cl_transit").value||0),
        cl_other: Number(document.getElementById("cl_other").value||0),
        note: document.getElementById("saleNote").value
      };
      const list = getSales(); list.push(rec); setSales(list);
      renderSales(); renderHome();
    };
    function renderSales(){
      const tb = document.getElementById("salesBody"); tb.innerHTML = "";
      getSales().forEach(r => {
        const tot = (r.cash||0) + (r.card||0) + (r.cl_paypay||0) + (r.cl_transit||0) + (r.cl_other||0);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td>
                        <td>${r.note||""}</td>
                        <td>現金${fmt(r.cash)} カード${fmt(r.card)} CL${fmt((r.cl_paypay||0)+(r.cl_transit||0)+(r.cl_other||0))}</td>
                        <td>${fmt(tot)}</td>`;
        tb.appendChild(tr);
      });
    }

    // 顧客管理＋来店回数
    function getCust(){ return JSON.parse(localStorage.getItem(CUST_KEY) || "[]"); }
    function setCust(v){ localStorage.setItem(CUST_KEY, JSON.stringify(v)); }
    document.getElementById("saveCustomer").onclick = () => {
      const c = {
        name: document.getElementById("custName").value,
        contact: document.getElementById("custContact").value,
        memo: document.getElementById("custMemo").value,
        visits: 0
      };
      const list = getCust(); list.push(c); setCust(list);
      renderCust();
    };
    function renderCust(){
      const tb = document.getElementById("custBody"); tb.innerHTML = "";
      getCust().forEach((c,i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c.name||""}</td>
                        <td>${c.contact||""}</td>
                        <td>${c.memo||""}</td>
                        <td>
                          <button onclick="updateVisit(${i},-1)">−</button>
                          ${c.visits||0}
                          <button onclick="updateVisit(${i},1)">＋</button>
                        </td>`;
        tb.appendChild(tr);
      });
    }
    window.updateVisit = (i, d) => {
      const list = getCust();
      list[i].visits = Math.max(0, (list[i].visits||0) + d);
      setCust(list);
      renderCust();
    };

    // 全体来店回数（ホームの±）
    function getVisits(){ return Number(localStorage.getItem(VISIT_KEY) || 0); }
    function setVisits(v){ localStorage.setItem(VISIT_KEY, String(Math.max(0, v))); }
    document.getElementById("incVisit").onclick = () => { setVisits(getVisits()+1); renderHome(); };
    document.getElementById("decVisit").onclick = () => { setVisits(getVisits()-1); renderHome(); };

    // ホーム表示
    function renderHome(){
      const today = new Date().toISOString().slice(0,10);
      const list = getSales().filter(r => r.date === today);
      let cash=0, card=0, cl=0;
      list.forEach(r => {
        cash += Number(r.cash||0);
        card += Number(r.card||0);
        cl   += Number(r.cl_paypay||0) + Number(r.cl_transit||0) + Number(r.cl_other||0);
      });
      document.getElementById("todayCash").textContent  = fmt(cash);
      document.getElementById("todayCard").textContent  = fmt(card);
      document.getElementById("todayCL").textContent    = fmt(cl);
      document.getElementById("todayTotal").textContent = fmt(cash+card+cl);

      // 日別サマリー（シンプル集計）
      const map = {};
      getSales().forEach(r => {
        const d = r.date||"";
        const t = (Number(r.cash||0)+Number(r.card||0)+Number(r.cl_paypay||0)+Number(r.cl_transit||0)+Number(r.cl_other||0));
        if(!map[d]) map[d] = {sum:0,cash:0,card:0,cl:0,count:0};
        map[d].sum  += t;
        map[d].cash += Number(r.cash||0);
        map[d].card += Number(r.card||0);
        map[d].cl   += Number(r.cl_paypay||0)+Number(r.cl_transit||0)+Number(r.cl_other||0);
        map[d].count++;
      });
      const rows = Object.entries(map).map(([date,v])=>({date,...v})).sort((a,b)=>a.date<b.date?1:-1).slice(0,30);
      const tb = document.getElementById("summaryBody"); tb.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td>
                        <td>${fmt(r.sum)}</td>
                        <td>${fmt(r.cash)}</td>
                        <td>${fmt(r.card)}</td>
                        <td>${fmt(r.cl)}</td>
                        <td>${fmt(r.count)}</td>`;
        tb.appendChild(tr);
      });

      document.getElementById("visitCount").textContent = fmt(getVisits());
    }
    // データ削除
    document.getElementById("resetData").onclick = () => {
      if(confirm("全データ削除しますか？")) {
        localStorage.clear();
        renderHome(); renderSales(); renderCust();
      }
    };

    // 初期描画
    renderHome(); renderSales(); renderCust();
  </script>
</body>
</html>
